### 什么是NETCONF
网络配置协议**NETCONF**（Network Configuration Protocol）为网管和网络设备之间通信提供了一套协议，网管通过NETCONF协议对远端设备的配置进行**下发、修改和删除**等操作。网络设备提供了规范的应用程序编程接口API（Application Programming Interface），网管可以通过NETCONF使用这些API管理网络设备。
NETCONF是基于**可扩展标记语言XML**（Extensible Markup Language）的网络配置和管理协议，使用简单的基于RPC（Remote Procedure Call）机制实现客户端和服务器之间通信。客户端可以是脚本或者网管上运行的一个应用程序。服务器是一个典型的网络设备。

### NETCONF的协议框架
```
  Layer                                 Example

 Content             Configuration Data          Notification Data
    |                       |                           |
Operations           <edit-config>,etc                  |
    |                       |                           |
 Messages            <rpc>,<rpc-reply>           <notification>
    |                       |                           |
Secure-Transport         SSH,TLS,BEEP/TLS,SOAP/HTTP/TLS,etc
```
NETCONF协议划分为四层：由低到高分别为**安全传输层**、**消息层**、**操作层**和**内容层**。

1. **安全传输层**：提供了客户端和服务器之间的通信路径。NETCONF协议可以使用任何符合基本要求的**传输层协议**承载。NETCONF传输层首选推荐SSH协议，XML信息通过SSH协议承载。

2. **消息层**：提供一种简易的不依赖于传输层，生成**RPC和通知消息**框架的通信协议。客户端把RPC请求封装在一个<rpc>元素内，发送给服务器；服务器把请求处理的结果封装在一个<rpc-reply>元素内，回应给客户端。

3. **操作层**：定义一组基本的操作，作为**RPC的调用方法**，可以使用XML编码的参数调用这些方法。

4. **内容层**：由管理数据内容的**数据模型**定义。目前主流的数据模型有Schema模型、YANG模型等。
   - **Schema**是为了描述XML文档而定义的一套规则。设备通过Schema文件向网管提供配置和管理设备的接口。Schema文件类似于SNMP的MIB文件。
   - **YANG**是专门为NETCONF协议设计的数据建模语言。客户端可以将RPC操作编译成XML格式的报文，XML遵循YANG模型约束进行客户端和服务器之间通信。

### 配置数据库
所谓配置数据库是关于设备的一套完整的配置参数的集合。NETCONF定义了一个或多个配置数据库的存在，并允许对它们进行配置操作。

NETCONF基本模型中只存在`<running/>`配置数据库。 其他配置数据库可以由能力集定义，且只在宣称支持该能力集的设备上可用。

- `<running/>`：**运行配置数据库**，保存网络设备上当前处于活动状态的完整配置。
在设备上只存在一个此类型的配置数据库，并且始终存在。

- `<candidate/>`：**备用配置数据库**，存放设备将要提交到`<running/>`的各项配置数据的集合。管理员可以在`<candidate/>`上进行操作，对`<candidate/>`的任何改变不会直接影响网络设备。可以通过`<commit>`指令将备用配置数据提交为设备运行数据。

- `<startup/>`：**启动配置数据库**，存放设备启动时所加载的配置数据，相当于已保存的配置文件。


### RPC操作
RFC6244文件中定义了一系列**RPC操作**如下：

| 操作          | 描述                                      |
|:-------------:|------------------------------------------|
| commit        | 将“候选配置”提交到“运行配置”               |
| copy-config   | 将一个配置数据库的数据拷贝到另一个配置数据库 |
| delete-config | 用来删除一个配置数据库                     |
| edit-config   | 修改配置数据存储的内容                     |
| get-config    | 获取配置数据存储的全部或部分内容            |
| lock          | 用来锁定指定的配置数据库                   |
| unlock        | 释放对该配置数据库的锁定                   |
| close-session | 用来正常关闭当前NETCONF会话                |
| kill-session  | 用来强制关闭一个NETCONF会话，需要管理员权限 |

### NETCONF标准能力集
除了基本RPC操作，NETCONF协议还定义了一系列**标准能力集**。这些标准能力定义了一些新的操作，使NETCONF功能更加强大，并使其在容错性、可扩展性等方面得到加强，最终将有利于实现基于NETCONF的开放式网络管理体系结构。

- **Writable-running**
此能力指明设备支持对`<running/>`配置数据库的写能力，即设备支持对运行的配置进行`<edit-config>`和`<copy-config>`操作。

- **Candidate Configuration**
此能力指明设备支持`<candidate/>`备用配置数据库。`<candidate/>`配置数据库中存放设备一套完整的配置数据。操作这些配置数据时，不会影响设备当前运行的配置数据。

- **Confirmed Commit**
此能力指明设备支持协议操作`<commit>`携带参数`<confirmed>`和`<confirm-timeout>`，主要应用于对业务进行试运行、验证的场景中。
  - `<confirmed>`：将`<candidate/>`数据库中的配置数据提交，转化为设备当前运行的`<running/>`数据库中的配置。
  - `<confirm-timeout>`：`<commit>`操作确认超时时间，单位是秒，缺省值是600秒。
- 此能力仅在设备支持Candidate Configuration能力时有效。

- **Rollback on Error**
此能力指明设备具备错误回滚能力。即支持在`<edit-config>`操作的`<error-option>`参数中携带`rollback-on-error`字段，如果在执行`<edit-config>`操作时出现错误并产生错误元素`<rpc-error>`，则服务器将停止处理`<edit-config>`操作，并将配置恢复至执行`<edit-config>`操作之前的状态。
  - 此能力仅在设备支持Candidate Configuration能力时生效。

- **Distinct Startup**
此能力指明设备具备独立启动的能力，即设备能够区分运行数据库`<running/>`和启动数据库`<startup/>`。
  - 对`<running/>`数据库的配置操作不会自动同步到`<startup/>`数据库，必须执行一个从`<running/>`到`<startup/>`的操作（例如`<copy-config>`操作），才能把`<running/>`数据库中的数据更新到`<startup/>`数据库中。

- **Notification**
此能力指明设备可以通过NETCONF协议的Notification能力向客户端上报告警和事件，以便客户端及时感知设备配置等的变更。

- **XPath**
此能力指明设备具备在`<filter>`元素中使用XPath表达式作为查询条件的能力。`<get>`、`<get-config>`操作可通过XPath查询指定数据。

- **Validate**
此能力指明设备具备配置顺序无关下发的能力，即在配置下发时只进行语法校验，不对配置顺序进行校验。在配置提交时进行语义校验，把下发的配置顺序调整正确后提交至`<running/>`。

- **URL**
此能力指明设备具备对自定义路径下的文件进行编辑、拷贝操作的能力，目前支持`<edit-config>`和`<copy-config>`操作。支持对URL路径中的密码信息进行保护，支持配置数据导出时密码信息以密文方式输出。

- **Interleave**
此能力指明设备支持NETCONF会话多功能重用。用户可在同一个NETCONF会话上同时对设备进行维护操作和告警、事件管理，提升管理效率。

- **With-defaults**
此能力指明设备具备处理模型默认值的能力，`<get>`、`<get-config>`、`<copy-config>`操作中支持携带with-defaults参数。