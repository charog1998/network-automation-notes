好的，太棒了！拿到官方的 `.proto` 文件，我们就可以进行最地道的、基于 Protobuf 编码的 Telemetry 实验了。

下面我将为你梳理在 EVE-NG (NE40E) 和 Windows 10 (Python) 环境下，**Dial-Out (推送模式)** 和 **Dial-In (拉取模式)** 的完整实验过程。

### 环境准备与关键配置

在开始具体实验前，请务必完成以下准备工作。

#### 1. 网络连通性
*   **桥接网络**：确保你的 EVE-NG 虚拟机和你的 Windows 10 物理机在同一个物理网络中，并且可以相互 `ping` 通。
*   **获取 IP**：记录下你的 **Windows 10 主机的 IP 地址**（例如 `192.168.1.100`），它将作为 Dial-Out 模式的目标地址。
*   **获取 IP**：在 EVE-NG 中为 NE40E 配置一个管理 IP 地址（例如 `192.168.1.200`），它将作为 Dial-In 模式的目标地址。

#### 2. 防火墙配置
*   在你的 **Windows 10 主机**上，打开 "高级安全 Windows Defender 防火墙"。
*   **添加入站规则**，允许 TCP 端口 `50052` (用于 Dial-Out 收集器) 和 `50051` (如果需要从外部访问) 的流量。

#### 3. Python 环境准备
*   确保已安装 `grpcio` 和 `grpcio-tools`。
    ```bash
    pip install grpcio grpcio-tools
    ```
*   **项目文件结构**：在你的 Windows 10 上创建一个项目文件夹（例如 `D:\huawei_telemetry`），并按如下结构组织文件：
    ```
    D:\huawei_telemetry\
    ├── gnmi/
    │   ├── gnmi.proto          # 从 openconfig/gnmi 下载
    │   └── gnmi_ext.proto      # 从 openconfig/gnmi 下载
    ├── huawei/
    │   ├── huawei-telemetry.proto  # 从华为官方获取
    │   ├── huawei-ifm.proto        # 从华为官方获取 (接口模型)
    │   └── ... (其他业务 proto)
    ├── dialin_client.py        # 我们将创建
    └── dialout_collector.py    # 我们将创建
    ```
*   **生成 Python 代码**：打开命令行，进入 `D:\huawei_telemetry` 目录，运行以下命令来编译 `.proto` 文件。
    ```bash
    # 编译 gnmi.proto
    python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. gnmi/gnmi.proto
    
    # 编译华为的 proto (以 huawei-telemetry.proto 和 huawei-ifm.proto 为例)
    # 注意：如果 huawei-telemetry.proto 依赖其他文件，需要将它们也列出来
    python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. huawei/huawei-telemetry.proto huawei/huawei-ifm.proto
    ```
    成功后，`gnmi` 和 `huawei` 目录下会生成对应的 `_pb2.py` 和 `_pb2_grpc.py` 文件。

---

### 实验一：Dial-Out (推送模式)

**目标**：NE40E 作为客户端，主动连接到你的 Windows 10 主机上的 Python 收集器，并周期性地推送接口统计数据。

#### 第 1 步：在 NE40E 上配置 Telemetry

这是整个实验的核心配置。我们将配置设备以 `Protobuf` 编码，向你的 Windows 主机推送数据。

```bash
# 1. 进入系统视图
system-view

# 2. 配置 gRPC 客户端的 SSL 策略 (如果收集器使用 TLS)
# 为了简化实验，我们这里先使用不安全模式。
# 如果你想使用 TLS，需要配置 PKI 并指定 SSL 策略。

# 3. 配置 Telemetry
telemetry
 # 创建一个订阅
 subscription sub1
  # 配置采样路径，这里我们订阅接口 GigabitEthernet 1/0/1 的入方向字节数
  # 路径必须与 .proto 文件中的消息结构匹配
  sensor-path huawei-ifm:ifm/interfaces/interface[name='GigabitEthernet1/0/1']/statistics/in-octets
  
  # 配置采样间隔为 5000 毫秒 (5秒)
  sample-interval 5000
  
  # 【关键】配置编码格式为 protobuf
  encoding protobuf
  
  # 配置目标收集器 (你的 Windows 10 主机)
  destination ip 192.168.1.100 port 50052 protocol grpc
 quit
quit

# 4. 验证配置
display telemetry subscription sub1
```

#### 第 2 步：编写 Python Dial-Out 收集器 (`dialout_collector.py`)

这个脚本将作为 gNMI Collector，监听 `50052` 端口，接收 NE40E 推送的数据，并使用华为的 `.proto` 文件来解析它。

```python
import grpc
import time
from concurrent import futures
import gnmi.gnmi_pb2 as gnmi_pb2
import gnmi.gnmi_pb2_grpc as gnmi_pb2_grpc
# 导入华为的 proto 生成的代码
import huawei.huawei_telemetry_pb2 as huawei_telemetry_pb2
import huawei.huawei_ifm_pb2 as huawei_ifm_pb2

_ONE_DAY_IN_SECONDS = 60 * 60 * 24
LISTEN_ADDRESS = '[::]:50052'

class GnmiCollector(gnmi_pb2_grpc.gNMIServicer):
    def Subscribe(self, request_iterator, context):
        print("NE40E has connected for Dial-Out Telemetry!")
        try:
            for request in request_iterator:
                if request.HasField('update'):
                    update_response = request.update
                    for notification in update_response.notification:
                        print(f"\n--- Received Dial-Out Update (Timestamp: {notification.timestamp}) ---")
                        for update in notification.update:
                            path_str = "/".join([elem.name for elem in update.path.elem])
                            print(f"  Path: {path_str}")
                            
                            # 数据在 val.bytes_val 中，是一个二进制的 Protobuf 消息
                            telemetry_data_bytes = update.val.bytes_val
                            
                            # 【关键】使用 huawei_telemetry_pb2 来解析外层消息
                            telemetry_msg = huawei_telemetry_pb2.Telemetry()
                            telemetry_msg.ParseFromString(telemetry_data_bytes)
                            
                            # telemetry_msg.data 字段包含了具体的业务数据，它本身也是一个 Protobuf 消息
                            # 我们需要根据路径判断其类型，并使用对应的 .proto 来解析
                            # 这里我们知道它是 huawei-ifm 的数据
                            ifm_stats_msg = huawei_ifm_pb2.InterfaceStatistics()
                            ifm_stats_msg.ParseFromString(telemetry_msg.data)
                            
                            print(f"  Parsed Data:")
                            print(f"    Interface Name: {ifm_stats_msg.interface_name}")
                            print(f"    In Octets: {ifm_stats_msg.in_octets}")
        except Exception as e:
            print(f"An error occurred: {e}")
        finally:
            print("NE40E disconnected.")
        
        # gRPC 流式 RPC 需要返回一个迭代器，即使是空的
        return iter([])

def serve():
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))
    gnmi_pb2_grpc.add_gNMIServicer_to_server(GnmiCollector(), server)
    
    # 使用不安全的端口进行监听
    server.add_insecure_port(LISTEN_ADDRESS)
    print(f"Starting gNMI Collector on {LISTEN_ADDRESS} (insecure)...")
    
    server.start()
    print("Collector is running. Press Ctrl+C to stop.")
    try:
        while True:
            time.sleep(_ONE_DAY_IN_SECONDS)
    except KeyboardInterrupt:
        server.stop(0)

if __name__ == '__main__':
    serve()
```

#### 第 3 步：运行与验证

1.  在你的 Windows 10 主机上，打开命令行，进入项目目录，运行收集器脚本：
    ```bash
    python dialout_collector.py
    ```
2.  脚本启动后，等待 NE40E 发起连接。
3.  连接成功后，你将在命令行中看到类似以下的输出，每 5 秒刷新一次：
    ```
    NE40E has connected for Dial-Out Telemetry!

    --- Received Dial-Out Update (Timestamp: 167...880) ---
      Path: ifm/interfaces/interface/statistics/in-octets
      Parsed Data:
        Interface Name: GigabitEthernet1/0/1
        In Octets: 123456

    --- Received Dial-Out Update (Timestamp: 167...885) ---
      Path: ifm/interfaces/interface/statistics/in-octets
      Parsed Data:
        Interface Name: GigabitEthernet1/0/1
        In Octets: 123999
    ```

---

### 实验二：Dial-In (拉取模式)

**目标**：你的 Windows 10 主机上的 Python 脚本作为客户端，主动连接到 NE40E，发送一个 `Get` 请求，获取指定接口的配置数据。

#### 第 1 步：在 NE40E 上配置 gRPC 服务器

```bash
# 1. 进入系统视图
system-view

# 2. 开启 gRPC 服务器
grpc server enable

# 3. (可选) 配置 SSL 策略和端口
# grpc server ssl-policy your_policy
# grpc server port 50051

# 4. 验证配置
display grpc server
```

#### 第 2 步：编写 Python Dial-In 客户端 (`dialin_client.py`)

这个脚本将连接到 NE40E 的 gRPC 端口 (`50051`)，发送 `GetRequest`，并解析返回的 `GetResponse`。

```python
import grpc
import gnmi.gnmi_pb2 as gnmi_pb2
import gnmi.gnmi_pb2_grpc as gnmi_pb2_grpc
# 导入华为的 proto 生成的代码
import huawei.huawei_ifm_pb2 as huawei_ifm_pb2

# NE40E 的 gRPC 服务器地址和端口
TARGET = '192.168.1.200:50051'
# NE40E 的用户名和密码
USERNAME = 'admin'
PASSWORD = 'your_password'

def dialin_get_example():
    try:
        # 创建不安全的 gRPC 通道
        channel = grpc.insecure_channel(TARGET)
        stub = gnmi_pb2_grpc.gNMIStub(channel)

        # 配置元数据，用于认证
        metadata = [('username', USERNAME), ('password', PASSWORD)]

        # 定义要获取的路径
        # 这里我们获取接口 GigabitEthernet 1/0/1 的配置
        path = gnmi_pb2.Path(
            elem=[
                gnmi_pb2.PathElem(name='ifm'),
                gnmi_pb2.PathElem(name='interfaces'),
                gnmi_pb2.PathElem(name='interface', key={'name': 'GigabitEthernet1/0/1'}),
                gnmi_pb2.PathElem(name='config')
            ]
        )

        # 创建 GetRequest
        get_request = gnmi_pb2.GetRequest(
            path=[path],
            # 明确指定要获取配置数据
            type=gnmi_pb2.GetRequest.Config
        )

        print(f"Sending Get request to {TARGET} for path: {path}")
        
        # 发送 Get 请求
        get_response = stub.Get(get_request, metadata=metadata)

        print("\n--- Received Dial-In Get Response ---")
        print(get_response)

        # 解析返回的数据
        # GetResponse 中的 notification 字段包含数据
        for notification in get_response.notification:
            for update in notification.update:
                print(f"\n  Parsing Update for path: {update.path}")
                
                # 数据在 val.bytes_val 中
                config_data_bytes = update.val.bytes_val
                
                # 使用对应的 .proto 解析
                ifm_config_msg = huawei_ifm_pb2.InterfaceConfig()
                ifm_config_msg.ParseFromString(config_data_bytes)
                
                print(f"  Parsed Interface Config:")
                print(f"    Name: {ifm_config_msg.name}")
                print(f"    Description: {ifm_config_msg.description}")
                print(f"    Admin Status: {ifm_config_msg.admin_status}")

    except grpc.RpcError as e:
        print(f"gRPC Error: {e.code()} - {e.details()}")
    except Exception as e:
        print(f"An error occurred: {e}")

if __name__ == '__main__':
    dialin_get_example()
```

#### 第 3 步：运行与验证

1.  在你的 Windows 10 主机上，打开命令行，进入项目目录，运行客户端脚本：
    ```bash
    python dialin_client.py
    ```
2.  脚本会立即执行，并打印出从 NE40E 获取到的接口配置信息：
    ```
    Sending Get request to 192.168.1.200:50051 for path: ...

    --- Received Dial-In Get Response ---
    notification {
      timestamp: 167...890
      update {
        path {
          elem {
            name: "ifm"
          }
          ...
        }
        val {
          bytes_val: "..."
        }
      }
    }

      Parsing Update for path: ...
      Parsed Interface Config:
        Name: GigabitEthernet1/0/1
        Description: TO_EVE_NG_SWITCH
        Admin Status: 1
    ```

至此，你已经成功完成了基于 Protobuf 编码的 Dial-Out 和 Dial-In 两种模式的 gNMI Telemetry 实验！